// Firestore
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return request.auth.uid == uid; }
    function isAdmin() {
      return isSignedIn() &&
        get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if isOwner(uid);
      allow update: if isOwner(uid) && (
        !('role' in request.resource.data || 'verified' in request.resource.data)
        ||
        (
          request.resource.data.role == 'tutor' &&
          request.resource.data.verified == true &&
          get(/databases/$(db)/documents/verificationSubmissions/$(uid)).data.status == 'approved'
        )
      );
    }

    match /verificationSubmissions/{uid} {
      allow create: if isOwner(uid);
      allow read: if isOwner(uid) || isAdmin();
      allow update: if isOwner(uid) || isAdmin();
      allow delete: if isAdmin();
    }

    match /subjects/{id} { allow read: if true; }

    match /chats/{chatId} {
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantIds;
      allow read, update, delete: if isSignedIn() && request.auth.uid in resource.data.participantIds;
    }

    match /chats/{chatId}/messages/{msgId} {
      allow read, create, delete: if isSignedIn() &&
        request.auth.uid in get(/databases/$(db)/documents/chats/$(chatId)).data.participantIds;
    }
  }
}